<div class="risk-management-container">
  <!-- Header -->
  <div class="header">
    <h1 class="title">Risk Management</h1>
    <button class="new-risk-btn" (click)="navigateToNewRisk()">
      <span class="plus-icon">+</span>
      New Risk
    </button>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab" 
      [class.active]="selectedTab === 'register'"
      (click)="selectTab('register')">
      Risk Register
    </button>
    <button 
      class="tab" 
      [class.active]="selectedTab === 'matrix'"
      (click)="selectTab('matrix')">
      Risk Matrix
    </button>
  </div>

  <!-- Risk Register Content -->
  <div *ngIf="selectedTab === 'register'" class="risk-register">
    <div class="register-header">
      <h2>Risk Register</h2>
      <p class="subtitle">View and manage all identified risks. Click on a risk to view its Bowtie diagram.</p>
    </div>

    <!-- Search and Controls -->
    <div class="controls">
      <div class="search-container">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search risks..."
          [(ngModel)]="searchTerm"
          (input)="onSearch()">
      </div>
      <div class="action-buttons">
        <button class="filter-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 4.6C3 4.03995 3 3.75992 3.10899 3.54601C3.20487 3.35785 3.35785 3.20487 3.54601 3.10899C3.75992 3 4.03995 3 4.6 3H19.4C19.9601 3 20.2401 3 20.454 3.10899C20.6422 3.20487 20.7951 3.35785 20.891 3.54601C21 3.75992 21 4.03995 21 4.6V6.33726C21 6.58185 21 6.70414 20.9724 6.81923C20.9479 6.92127 20.9075 7.01881 20.8526 7.10828C20.7908 7.2092 20.7043 7.29568 20.5314 7.46863L14.4686 13.5314C14.2957 13.7043 14.2092 13.7908 14.1474 13.8917C14.0925 13.9812 14.0521 14.0787 14.0276 14.1808C14 14.2959 14 14.4182 14 14.6627V17L10 21V14.6627C10 14.4182 10 14.2959 9.97237 14.1808C9.94787 14.0787 9.90747 13.9812 9.85264 13.8917C9.7908 13.7908 9.70432 13.7043 9.53137 13.5314L3.46863 7.46863C3.29568 7.29568 3.2092 7.2092 3.14736 7.10828C3.09253 7.01881 3.05213 6.92127 3.02763 6.81923C3 6.70414 3 6.58185 3 6.33726V4.6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="sort-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 6h18M7 12h10m-7 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Risk Table -->
    <div class="table-container">
      <table class="risks-table">
        <thead>
          <tr>
            <th>Risk ID</th>
            <th>Description</th>
            <th>Likelihood</th>
            <th>Severity</th>
            <th>Risk Level</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Review Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr 
            *ngFor="let risk of paginatedRisks" 
            class="risk-row"
            (click)="onRiskClick(risk)">
            <td class="risk-id">{{ risk.id }}</td>
            <td class="description">{{ risk.description }}</td>
            <td>
              <span class="likelihood-badge likelihood-{{risk.likelihood.toLowerCase()}}">{{ risk.likelihood }}</span>
            </td>
            <td>
              <span class="severity-badge severity-{{risk.severity.toLowerCase()}}">{{ risk.severity }}</span>
            </td>
            <td>
              <span class="risk-level-badge" [class]="risk.riskLevelColor">
                {{ risk.riskLevel }} ({{ risk.riskScore }})
              </span>
            </td>
            <td >{{ risk.owner }}</td>
            <td>
              <span class="status-badge" [class]="risk.statusColor">{{ risk.status }}</span>
            </td>
            <td >{{ risk.reviewDate }}</td>
            <td>
              <div class="actions-dropdown" [class.open]="openDropdownId === risk.id">
                <button 
                  class="more-actions-btn"
                  (click)="toggleDropdown($event, risk.id)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM19 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM5 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="dropdown-menu" *ngIf="openDropdownId === risk.id">
                  <button class="dropdown-item view-item" (click)="viewBowtie($event, risk)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    View Bowtie
                  </button>
                  <button class="dropdown-item edit-item" (click)="editRisk($event, risk)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Edit Risk
                  </button>
                  <button class="dropdown-item delete-item" (click)="deleteRisk($event, risk)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="m3 6 3 0m0 0 14 0m-14 0v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M10 3h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Delete Risk
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container">
      <div class="pagination-info">
        <span class="results-count">
          Showing {{ ((currentPage - 1) * itemsPerPage) + 1 }} to {{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} results
        </span>
        <div class="items-per-page">
          <label for="itemsPerPage">Items per page:</label>
          <select 
            id="itemsPerPage" 
            [value]="itemsPerPage" 
            (change)="changeItemsPerPage(+$event.target.value)"
            class="items-select">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="pagination-controls" *ngIf="totalPages > 1">
        <button 
          class="pagination-btn prev-btn" 
          [disabled]="currentPage === 1"
          (click)="previousPage()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="m15 18-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Previous
        </button>
        
        <div class="page-numbers">
          <button 
            *ngFor="let pageNum of getPageNumbers()" 
            class="page-btn"
            [class.active]="pageNum === currentPage"
            (click)="goToPage(pageNum)">
            {{ pageNum }}
          </button>
        </div>
        
        <button 
          class="pagination-btn next-btn" 
          [disabled]="currentPage === totalPages"
          (click)="nextPage()">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="m9 18 6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Risk Matrix Content -->
  <div *ngIf="selectedTab === 'matrix'" class="risk-matrix">
    <div class="matrix-header">
      <h2>Risk Matrix</h2>
      <p class="subtitle">Visualize risks based on likelihood and severity.</p>
    </div>

    <div class="matrix-content">
      <!-- Risk Matrix Grid -->
      <div class="matrix-container">
        <div class="matrix-grid">
          <!-- Y-axis label -->
          <div class="axis-label y-axis-label">Likelihood</div>
          
          <!-- Y-axis numbers -->
          <div class="y-axis">
            <div class="axis-number" *ngFor="let num of [5,4,3,2,1]">{{ num }}</div>
          </div>
          
          <!-- Matrix cells -->
          <div class="matrix-cells">
            <div class="matrix-row" *ngFor="let likelihood of [5,4,3,2,1]; let i = index">
              <div 
                class="matrix-cell" 
                *ngFor="let severity of [1,2,3,4,5]; let j = index"
                [class]="getMatrixCellClass(likelihood, severity)"
                (click)="onMatrixCellClick(likelihood, severity)"
                (mouseenter)="onMatrixCellHover(likelihood, severity, $event)"
                (mouseleave)="onMatrixCellLeave()">
                <span class="cell-score">{{ likelihood * severity }}</span>
                <span class="cell-count" *ngIf="getRisksAtPosition(likelihood, severity).length > 0">
                  {{ getRisksAtPosition(likelihood, severity).length }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- X-axis numbers -->
          <div class="x-axis">
            <div class="axis-number" *ngFor="let num of [1,2,3,4,5]">{{ num }}</div>
          </div>
          
          <!-- X-axis label -->
          <div class="axis-label x-axis-label">Severity</div>
        </div>

        <!-- Matrix Legend -->
        <div class="matrix-legend">
          <h3>Risk Levels</h3>
          <div class="legend-items">
            <div class="legend-item">
              <div class="legend-color low"></div>
              <span>Low (1-3)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color medium"></div>
              <span>Medium (4-7)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color high"></div>
              <span>High (8-14)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color critical"></div>
              <span>Critical (15-25)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Details Panel -->
      <div class="risk-details-panel" *ngIf="selectedMatrixRisks.length > 0">
        <div class="panel-header">
          <h3>{{ selectedMatrixRisks.length }} Risk{{ selectedMatrixRisks.length > 1 ? 's' : '' }} at L{{ selectedLikelihood }} x S{{ selectedSeverity }}</h3>
          <p class="risk-level-info">Risk Level: {{ getMatrixRiskLevel(selectedLikelihood, selectedSeverity) }}</p>
        </div>
        
        <div class="risk-cards">
          <div class="risk-card" *ngFor="let risk of selectedMatrixRisks">
            <div class="risk-card-header">
              <span class="risk-id">{{ risk.id }}</span>
              <span class="risk-level-badge" [class]="risk.riskLevelColor">
                {{ risk.riskLevel }} ({{ risk.riskScore }})
              </span>
            </div>
            <h4 class="risk-title">{{ risk.description }}</h4>
            <div class="risk-meta">
              <div class="risk-status">
                <span class="status-badge" [class]="risk.statusColor">{{ risk.status }}</span>
              </div>
              <div class="risk-owner">
                <span>Owner: {{ risk.owner }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Matrix Tooltip -->
      <div class="matrix-tooltip" 
           *ngIf="hoveredCell" 
           [style.left.px]="tooltipPosition.x" 
           [style.top.px]="tooltipPosition.y">
        <div class="tooltip-content">
          <div class="tooltip-header">
            Likelihood {{ hoveredCell.likelihood }} Ã— Severity {{ hoveredCell.severity }}
          </div>
          <div class="tooltip-risk-level">
            {{ getMatrixRiskLevel(hoveredCell.likelihood, hoveredCell.severity) }}
          </div>
          <div class="tooltip-risks" *ngIf="getRisksAtPosition(hoveredCell.likelihood, hoveredCell.severity).length > 0">
            <div class="tooltip-risk-count">
              {{ getRisksAtPosition(hoveredCell.likelihood, hoveredCell.severity).length }} risk(s) at this position
            </div>
          </div>
          <div class="tooltip-no-risks" *ngIf="getRisksAtPosition(hoveredCell.likelihood, hoveredCell.severity).length === 0">
            <div class="tooltip-risk-count">
              No risks at this position
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
