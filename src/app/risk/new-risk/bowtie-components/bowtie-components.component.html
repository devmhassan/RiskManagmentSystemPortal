<div class="form-container">
  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading risk data...</p>
  </div>

  <div class="page-header">
    <h1>Bowtie Components</h1>
    <p class="subtitle">Define the causes, consequences, and controls for the risk</p>
    <div *ngIf="isEditMode" class="edit-mode-indicator">
      <span class="badge badge-info">Edit Mode - Risk ID: {{ riskId }}</span>
    </div>
  </div>

  <form [formGroup]="bowtieForm">
    <!-- Two Column Layout -->
    <div class="row g-4">
      <!-- Causes Column -->
      <div class="col-lg-6">
        <div formArrayName="causes">
          <div *ngFor="let causeControl of causes.controls; let causeIndex = index" 
               [formGroupName]="causeIndex" class="mb-4">
            
            <!-- Cause Card -->
            <div class="card border-0 shadow-sm">
              <div class="card-body p-4" [style.background-color]="'#fff5f8'">
                
                <!-- Cause Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0 fw-semibold">Cause {{ causeIndex + 1 }}</h5>
                  <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-warning text-dark">L{{ causeControl.get('likelihood')?.value || 3 }}</span>
                    <span class="badge bg-danger">Highest</span>
                    <button type="button" 
                            class="btn btn-sm text-danger" 
                            (click)="removeCause(causeIndex)"
                            [disabled]="causes.length <= 1"
                            title="Remove Cause"
                            style="border: none; background: none;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

                <!-- Cause Description -->
                <div class="mb-3">
                  <label class="form-label text-dark fw-medium" [for]="'cause_desc_' + causeIndex">Risk Cause <span class="text-danger">*</span></label>
                  <input formControlName="description" 
                         [id]="'cause_desc_' + causeIndex"
                         [name]="'cause_desc_' + causeIndex"
                         placeholder="What could cause this risk to occur..." 
                         class="form-control border-0 bg-white">
                </div>

                <!-- Likelihood Section -->
                <div class="mb-3">
                  <label class="form-label text-dark fw-medium" [for]="'cause_likelihood_' + causeIndex">Likelihood (1-5) <span class="text-danger">*</span></label>
                  <select formControlName="likelihood" 
                          [id]="'cause_likelihood_' + causeIndex"
                          [name]="'cause_likelihood_' + causeIndex"
                          class="form-select">
                    <option value="">Select Likelihood</option>
                    <option *ngFor="let option of likelihoodOptions" [value]="option.value">
                      {{ option.value }} - {{ option.key }}
                    </option>
                  </select>
                </div>

                <!-- Preventive Actions -->
                <div class="mb-3">
                  <h6 class="fw-semibold mb-3">Preventive Actions</h6>
                  <div formArrayName="preventionActions">
                    <div *ngFor="let actionControl of causeControl.get('preventionActions')?.controls; let actionIndex = index" 
                         [formGroupName]="actionIndex" class="mb-3">
                      
                      <!-- Action Description -->
                      <div class="mb-2">
                        <label class="form-label text-dark fw-medium" [for]="'prev_desc_' + causeIndex + '_' + actionIndex">Action Description</label>
                        <input formControlName="description" 
                               [id]="'prev_desc_' + causeIndex + '_' + actionIndex"
                               [name]="'prev_desc_' + causeIndex + '_' + actionIndex"
                               placeholder="Action to prevent this cause..." 
                               class="form-control">
                      </div>
                      
                      <!-- Cost and Priority Row with Delete Button -->
                      <div class="row g-2 align-items-end">
                        <div class="col-4">
                          <label class="form-label text-dark fw-medium" [for]="'prev_cost_' + causeIndex + '_' + actionIndex">Cost <span class="text-danger">*</span></label>
                          <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" formControlName="cost" 
                                   [id]="'prev_cost_' + causeIndex + '_' + actionIndex"
                                   [name]="'prev_cost_' + causeIndex + '_' + actionIndex"
                                   class="form-control" placeholder="0" 
                                   min="0" step="0.01">
                          </div>
                        </div>
                        <div class="col-6">
                          <label class="form-label text-dark fw-medium" [for]="'prev_priority_' + causeIndex + '_' + actionIndex">Priority <span class="text-danger">*</span></label>
                          <select formControlName="priority" 
                                  [id]="'prev_priority_' + causeIndex + '_' + actionIndex"
                                  [name]="'prev_priority_' + causeIndex + '_' + actionIndex"
                                  class="form-select">
                            <option *ngFor="let option of actionPriorityOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                        </div>
                        
                        <!-- New fields for backend integration -->
                        <div class="status-assignment-row" *ngIf="isEditMode">
                          <select formControlName="status" class="status-select">
                            <option *ngFor="let option of actionStatusOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                          <input formControlName="assignedTo" 
                                 placeholder="Assigned to..." 
                                 class="form-control">
                          <input type="date" formControlName="dueDate" 
                                 class="form-control">
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Add Prevention Action Button -->
                  <button type="button" class="btn btn-outline-primary btn-sm mt-3" 
                          (click)="addPreventionAction(causeIndex)">
                    ‚ûï Add Preventive Action
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Another Cause Button -->
        <button type="button" class="btn btn-outline-secondary" (click)="addCause()">
          ‚ûï Add Another Cause
        </button>
      </div>

      <!-- Consequences Column -->
      <div class="col-lg-6">
        <div formArrayName="consequences">
          <div *ngFor="let consequenceControl of consequences.controls; let consequenceIndex = index" 
               [formGroupName]="consequenceIndex" class="mb-4">
            
            <!-- Consequence Card -->
            <div class="card border-0 shadow-sm">
              <div class="card-body p-4" [style.background-color]="'#fff5f8'">
                
                <!-- Consequence Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0 fw-semibold">Consequence {{ consequenceIndex + 1 }}</h5>
                  <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-warning text-dark">S{{ consequenceControl.get('severity')?.value || 3 }}</span>
                    <span class="badge bg-danger">Highest</span>
                    <button type="button" 
                            class="btn btn-sm text-danger" 
                            (click)="removeConsequence(consequenceIndex)"
                            [disabled]="consequences.length <= 1"
                            title="Remove Consequence"
                            style="border: none; background: none;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

                <!-- Consequence Description -->
                <div class="mb-3">
                  <label class="form-label text-dark fw-medium" [for]="'conseq_desc_' + consequenceIndex">Risk Consequence <span class="text-danger">*</span></label>
                  <input formControlName="description" 
                         [id]="'conseq_desc_' + consequenceIndex"
                         [name]="'conseq_desc_' + consequenceIndex"
                         placeholder="What could happen if this risk occurs..." 
                         class="form-control border-0 bg-white">
                </div>

                <!-- Severity and Potential Cost Row -->
                <div class="row g-3 mb-3">
                  <div class="col-6">
                    <label class="form-label text-dark fw-medium" [for]="'conseq_severity_' + consequenceIndex">Severity (1-5) <span class="text-danger">*</span></label>
                    <select formControlName="severity" 
                            [id]="'conseq_severity_' + consequenceIndex"
                            [name]="'conseq_severity_' + consequenceIndex"
                            class="form-select">
                      <option value="">Select Severity</option>
                      <option *ngFor="let option of severityOptions" [value]="option.value">
                        {{ option.value }} - {{ option.key }}
                      </option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label text-dark fw-medium" [for]="'conseq_cost_' + consequenceIndex">Potential Cost <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      <input type="number" formControlName="potentialCost" 
                             [id]="'conseq_cost_' + consequenceIndex"
                             [name]="'conseq_cost_' + consequenceIndex"
                             class="form-control" placeholder="0" 
                             min="0" step="0.01">
                    </div>
                  </div>
                </div>

                <!-- Mitigation Actions -->
                <div class="mb-3">
                  <h6 class="fw-semibold mb-3">Mitigation Actions</h6>
                  <div formArrayName="mitigationActions">
                    <div *ngFor="let actionControl of consequenceControl.get('mitigationActions')?.controls; let actionIndex = index" 
                         [formGroupName]="actionIndex" class="mb-3">
                      
                      <!-- Action Description -->
                      <div class="mb-2">
                        <label class="form-label text-dark fw-medium" [for]="'mitig_desc_' + consequenceIndex + '_' + actionIndex">Action Description</label>
                        <input formControlName="description" 
                               [id]="'mitig_desc_' + consequenceIndex + '_' + actionIndex"
                               [name]="'mitig_desc_' + consequenceIndex + '_' + actionIndex"
                               placeholder="Action to mitigate this consequence..." 
                               class="form-control">
                      </div>
                      
                      <!-- Priority Row with Delete Button -->
                      <div class="row g-2 align-items-end">
                        <div class="col-10">
                          <label class="form-label text-dark fw-medium" [for]="'mitig_priority_' + consequenceIndex + '_' + actionIndex">Priority <span class="text-danger">*</span></label>
                          <select formControlName="priority" 
                                  [id]="'mitig_priority_' + consequenceIndex + '_' + actionIndex"
                                  [name]="'mitig_priority_' + consequenceIndex + '_' + actionIndex"
                                  class="form-select">
                            <option *ngFor="let option of actionPriorityOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                        </div>
                        <div class="col-2">
                          <button type="button" 
                                  class="btn btn-sm text-danger w-100" 
                                  (click)="removeMitigationAction(consequenceIndex, actionIndex)"
                                  [disabled]="consequenceControl.get('mitigationActions')?.controls.length <= 1"
                                  title="Remove Action"
                                  style="border: none; background: none;">
                            üóëÔ∏è
                          </button>
                        </div>
                        
                        <!-- New fields for backend integration -->
                        <div class="status-cost-assignment-row" *ngIf="isEditMode">
                          <select formControlName="status" class="status-select">
                            <option *ngFor="let option of actionStatusOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                          <div class="cost-input">
                            <span class="currency">$</span>
                            <input type="number" formControlName="estimatedCost" 
                                   class="cost-value" placeholder="0.00" 
                                   min="0" step="0.01">
                          </div>
                          <input formControlName="assignedTo" 
                                 placeholder="Assigned to..." 
                                 class="form-control">
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Add Mitigation Action Button -->
                  <button type="button" class="btn btn-outline-primary btn-sm mt-3" 
                          (click)="addMitigationAction(consequenceIndex)">
                    ‚ûï Add Mitigation Action
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Another Consequence Button -->
        <button type="button" class="btn btn-outline-secondary" (click)="addConsequence()">
          ‚ûï Add Another Consequence
        </button>
      </div>
    </div>

    <!-- Form validation summary -->
    <div class="mt-4" *ngIf="!isFormValid() && bowtieForm.touched">
      <div class="alert alert-warning">
        <strong>Please complete all required fields and ensure at least one cause and consequence are defined.</strong>
      </div>
    </div>
  </form>
</div>
