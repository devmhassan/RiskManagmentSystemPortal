<div class="form-container">
  <!-- Loading indicator -->
  <div *ngIf="isComponentLoading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading risk data...</p>
  </div>

  <div class="page-header">
    <h1>Bowtie Components</h1>
    <p class="subtitle">Define the causes, consequences, and controls for the risk</p>
    <div *ngIf="isInEditMode()" class="edit-mode-indicator">
      <span class="badge badge-info">Edit Mode - Risk ID: {{ riskId }}</span>
    </div>
  </div>

  <form [formGroup]="bowtieForm">
    <div class="bowtie-section">
      <!-- Causes Container -->
      <div class="causes-container">
        <div formArrayName="causes">
          <div *ngFor="let causeControl of causes.controls; let causeIndex = index" 
               [formGroupName]="causeIndex" class="causes-section">
            <div class="heading">
              <span>Cause {{ causeIndex + 1 }}</span>
              <div class="badges">
                <span class="badge l3">L{{ causeControl.get('likelihood')?.value || 3 }}</span>
                <span class="badge s3">S{{ causeControl.get('severity')?.value || 3 }}</span>
              </div>
            </div>

            <div class="risk-card">
              <!-- Risk Description Input -->
              <div class="input-group">
                <input formControlName="description" 
                       placeholder="What could cause this risk to occur..." 
                       class="form-control">
                <button type="button" class="copy-btn">
                  <div class="copy-icon"></div>
                </button>
              </div>

              <!-- Risk Details -->
              <div class="risk-details">
                <div class="likelihood-section">
                  <label>Likelihood</label>
                  <select formControlName="likelihood" class="form-select">
                    <option value="">Select Likelihood</option>
                    <option *ngFor="let option of likelihoodOptions" [value]="option.value">
                      {{ option.value }} - {{ option.key }}
                    </option>
                  </select>
                </div>

                <div class="severity-section">
                  <label>Severity</label>
                  <select formControlName="severity" class="form-select">
                    <option value="">Select Severity</option>
                    <option *ngFor="let option of severityOptions" [value]="option.value">
                      {{ option.value }} - {{ option.key }}
                    </option>
                  </select>
                </div>

                <!-- Prevention Actions -->
                <div class="actions-section">
                  <h4>Prevention Actions</h4>
                  <div formArrayName="preventionActions">
                    <div *ngFor="let actionControl of causeControl.get('preventionActions')?.controls; let actionIndex = index" 
                         [formGroupName]="actionIndex" class="action-item">
                      <div class="action-input-group">
                        <input formControlName="description" 
                               placeholder="Describe prevention action..." 
                               class="form-control">
                        <button type="button" class="remove-action-btn" 
                                (click)="removePreventionAction(causeIndex, actionIndex)"
                                [disabled]="causeControl.get('preventionActions')?.controls.length <= 1">
                          ×
                        </button>
                      </div>
                      
                      <div class="action-details">
                        <div class="cost-priority-row">
                          <div class="cost-input">
                            <span class="currency">$</span>
                            <input type="number" formControlName="cost" 
                                   class="cost-value" placeholder="0.00" 
                                   min="0" step="0.01">
                          </div>
                          <select formControlName="priority" class="priority-select">
                            <option *ngFor="let option of actionPriorityOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                        </div>
                        
                        <!-- New fields for backend integration -->
                        <div class="status-assignment-row" *ngIf="isInEditMode()">
                          <select formControlName="status" class="status-select">
                            <option *ngFor="let option of actionStatusOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                          <input formControlName="assignedTo" 
                                 placeholder="Assigned to..." 
                                 class="form-control">
                          <input type="date" formControlName="dueDate" 
                                 class="form-control">
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <button type="button" class="add-action-btn" 
                          (click)="addPreventionAction(causeIndex)">
                    + Add Prevention Action
                  </button>
                </div>
              </div>
            </div>

            <!-- Remove Cause Button -->
            <button type="button" class="remove-cause-btn" 
                    (click)="removeCause(causeIndex)" 
                    [disabled]="causes.length <= 1">
              Remove Cause
            </button>
          </div>
        </div>

        <!-- Add Cause Button -->
        <button type="button" class="add-cause-btn" (click)="addCause()">
          + Add Another Cause
        </button>
      </div>

      <!-- Consequences Container -->
      <div class="consequences-container">
        <div formArrayName="consequences">
          <div *ngFor="let consequenceControl of consequences.controls; let consequenceIndex = index" 
               [formGroupName]="consequenceIndex" class="consequences-section">
            <div class="heading">
              <span>Consequence {{ consequenceIndex + 1 }}</span>
              <div class="badges">
                <span class="badge s3">S{{ consequenceControl.get('severity')?.value || 3 }}</span>
                <span class="badge highest">Impact</span>
              </div>
            </div>

            <div class="risk-card">
              <!-- Consequence Description Input -->
              <div class="input-group">
                <input formControlName="description" 
                       placeholder="What could be the consequence..." 
                       class="form-control">
                <button type="button" class="copy-btn">
                  <div class="copy-icon"></div>
                </button>
              </div>

              <!-- Consequence Details -->
              <div class="risk-details">
                <div class="severity-cost-section">
                  <div class="severity-section">
                    <label>Severity</label>
                    <select formControlName="severity" class="form-select">
                      <option value="">Select Severity</option>
                      <option *ngFor="let option of severityOptions" [value]="option.value">
                        {{ option.value }} - {{ option.key }}
                      </option>
                    </select>
                  </div>

                  <div class="potential-cost">
                    <label>Potential Cost</label>
                    <div class="cost-input">
                      <span class="currency">$</span>
                      <input type="number" formControlName="potentialCost" 
                             class="cost-value" placeholder="0.00" 
                             min="0" step="0.01">
                    </div>
                  </div>
                </div>

                <!-- Mitigation Actions -->
                <div class="actions-section">
                  <h4>Mitigation Actions</h4>
                  <div formArrayName="mitigationActions">
                    <div *ngFor="let actionControl of consequenceControl.get('mitigationActions')?.controls; let actionIndex = index" 
                         [formGroupName]="actionIndex" class="action-item">
                      <div class="action-input-group">
                        <input formControlName="description" 
                               placeholder="Describe mitigation action..." 
                               class="form-control">
                        <button type="button" class="remove-action-btn" 
                                (click)="removeMitigationAction(consequenceIndex, actionIndex)"
                                [disabled]="consequenceControl.get('mitigationActions')?.controls.length <= 1">
                          ×
                        </button>
                      </div>
                      
                      <div class="action-details">
                        <div class="priority-date-row">
                          <select formControlName="priority" class="priority-select">
                            <option *ngFor="let option of actionPriorityOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                          <input type="date" formControlName="dueDate" class="date-input">
                        </div>
                        
                        <!-- New fields for backend integration -->
                        <div class="status-cost-assignment-row" *ngIf="isInEditMode()">
                          <select formControlName="status" class="status-select">
                            <option *ngFor="let option of actionStatusOptions" [value]="option.value">
                              {{ option.key }}
                            </option>
                          </select>
                          <div class="cost-input">
                            <span class="currency">$</span>
                            <input type="number" formControlName="estimatedCost" 
                                   class="cost-value" placeholder="0.00" 
                                   min="0" step="0.01">
                          </div>
                          <input formControlName="assignedTo" 
                                 placeholder="Assigned to..." 
                                 class="form-control">
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <button type="button" class="add-action-btn" 
                          (click)="addMitigationAction(consequenceIndex)">
                    + Add Mitigation Action
                  </button>
                </div>
              </div>
            </div>

            <!-- Remove Consequence Button -->
            <button type="button" class="remove-consequence-btn" 
                    (click)="removeConsequence(consequenceIndex)" 
                    [disabled]="consequences.length <= 1">
              Remove Consequence
            </button>
          </div>
        </div>

        <!-- Add Consequence Button -->
        <button type="button" class="add-consequence-btn" (click)="addConsequence()">
          + Add Another Consequence
        </button>
      </div>
    </div>

    <!-- Form validation summary -->
    <div class="form-summary" *ngIf="!isFormValid() && bowtieForm.touched">
      <div class="alert alert-warning">
        <strong>Please complete all required fields and ensure at least one cause and consequence are defined.</strong>
      </div>
    </div>
  </form>
</div>
